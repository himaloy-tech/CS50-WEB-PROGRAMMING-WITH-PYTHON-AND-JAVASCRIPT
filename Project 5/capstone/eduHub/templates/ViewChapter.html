{% extends "layout.html" %}

{% block body %}
{% load static %}
{% block style %}
<style>
  h2 {
    padding: 20px;
  }

  p {
    padding-top: 6px !important;
    padding: 60px;
  }
</style>
{% endblock %}
<center>
  <h2 style="padding: 20px;">{{Post.title}}</h2>
</center>
<center>
  <p>{{Post.desc}}</p>
  {% if Post.video %}
  <video width="350" controls>
    <source src="{{Post.video.url}}" type="video/mp4">
  </video>
  {% endif %}
</center>
<hr>
{% if user.is_authenticated %}
<div class="form-group" style="margin: 27px;">
  <h3>Post a Comment</h3>
  <form method="POST" id="form">
    {% csrf_token %}
    <input type="number" name="postId" id="postId" value="{{Post.id}}" hidden>
    <input type="text" name="username" id="username" value="{{request.user.username}}" hidden>
    <input type="text" class="form-control" id="text" name="text" placeholder="Enter Text" required>
    <button type="submit" class="btn btn-primary" style="margin-top: 1rem;" id="sub-btn">Submit</button>
  </form>
</div>
{% endif %}
<hr>
<div class="comments">
</div>
{% endblock %}

{% block script %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
  $.ajaxSetup({
    beforeSend: function (xhr, settings) {
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
        // Only send the token to relative URLs i.e. locally.
        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
      }
    }
  });
  function bringComments() {
    let postId = document.querySelector('#postId').value;
    document.querySelector('.comments').innerHTML = '';
    fetch(`/GivemeComment/${postId}`)
    .then(response => response.json())
    .then(comments => {
      comments.forEach(comment => {
        let div = document.createElement('div');
        div.className = 'card';
        div.style.margin = '20px';
        let html = `<div class="card-header">
          ${comment.username}
          </div>
          <div class="card-body">
            <blockquote class="blockquote mb-0">
              <p>${comment.comment}</p>
              <footer class="blockquote-footer"><cite title="Source Title">${comment.time}</cite></footer>
            </blockquote>
          </div>`;
          div.innerHTML = html;
          document.querySelector('.comments').append(div);
        })
      })
  }
  document.addEventListener('DOMContentLoaded', () => {
    bringComments();
    $(document).on('submit', '#form', function (event) {
      event.preventDefault();
      let text = document.querySelector('#text').value;
      let postId = document.querySelector('#postId').value;
      let username = document.querySelector('#username').value;
      let data = {
        text: text.toString(),
        postId: postId.toString(),
        user: username.toString()
      };
      console.log(data);
      $.ajax({
        type: 'POST',
        url: '/PostComment',
        data: data,
        success: function (json) {
          document.querySelector('#text').value = '';
          bringComments();
          document.querySelector('#alert-message').innerHTML = json.message;
          document.querySelector('#al').style.display = 'block';
          $('.alert').show();
        }
      });
      return false;
    })
  })
</script>
{% endblock %}